#!/usr/bin/env bash
# Pre-commit hook for JeebsAI
# Prevents commits that break the webui or fail cargo check
#
# Install: git config core.hooksPath .githooks
# Or:      cp .githooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

ERRORS=0
err() { ((ERRORS++)); echo -e "${RED}✗ PRE-COMMIT:${NC} $1"; }
ok()  { echo -e "${GREEN}✓${NC} $1"; }

echo "Running pre-commit checks..."

# ── 1. Check staged webui files for basic validity ──
STAGED_HTML=$(git diff --cached --name-only --diff-filter=ACM | grep 'webui/.*\.html$' || true)
STAGED_JS=$(git diff --cached --name-only --diff-filter=ACM | grep 'webui/.*\.js$' || true)
STAGED_RS=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)

# ── 2. Verify auth.js not deleted ──
if git diff --cached --name-only --diff-filter=D | grep -q 'webui/auth.js'; then
    err "webui/auth.js is being DELETED — all pages depend on it!"
fi

# ── 3. Check staged HTML files ──
if [ -n "$STAGED_HTML" ]; then
    for f in $STAGED_HTML; do
        if [ ! -f "$f" ]; then continue; fi
        fname=$(basename "$f")

        # Must include auth.js
        if ! grep -q 'auth.js' "$f"; then
            err "$fname does not include auth.js"
        fi

        # Check for unclosed script tags
        opens=$(grep -o '<script' "$f" | wc -l | tr -d ' ')
        closes=$(grep -o '</script>' "$f" | wc -l | tr -d ' ')
        if [ "$opens" != "$closes" ]; then
            err "$fname has mismatched script tags ($opens open, $closes close)"
        fi

        # Admin pages must have auth guard
        case "$fname" in
            admin_dashboard.html|admin_blacklist.html|admin_whitelist.html|evolution.html|logs.html)
                if ! grep -q 'requireAuth("admin")' "$f"; then
                    err "$fname missing requireAuth(\"admin\") guard"
                fi
                ;;
            trainer_panel.html)
                if ! grep -q 'requireAuth("trainer")' "$f"; then
                    err "$fname missing requireAuth(\"trainer\") guard"
                fi
                ;;
        esac

        ok "$fname validated"
    done
fi

# ── 4. Rust check (if .rs files changed) ──
if [ -n "$STAGED_RS" ]; then
    echo "Checking Rust compilation..."
    if ! cargo check 2>&1 | tail -3 | grep -q 'Finished'; then
        if cargo check 2>&1 | grep -q '^error'; then
            err "cargo check failed — Rust compilation errors"
            cargo check 2>&1 | grep '^error' | head -5
        fi
    else
        ok "cargo check passes"
    fi
fi

# ── 5. Check for accidentally deleted required files ──
DELETED=$(git diff --cached --name-only --diff-filter=D || true)
REQUIRED_PAGES="webui/index.html webui/admin_dashboard.html webui/trainer_panel.html webui/evolution.html webui/logs.html webui/admin_blacklist.html webui/admin_whitelist.html"

for page in $REQUIRED_PAGES; do
    if echo "$DELETED" | grep -q "^$page$"; then
        err "$page is being DELETED — this is a required page!"
    fi
done

# ── Result ──
echo ""
if [ "$ERRORS" -gt 0 ]; then
    echo -e "${RED}Pre-commit check FAILED with $ERRORS error(s).${NC}"
    echo -e "${YELLOW}Fix the issues above, then try committing again.${NC}"
    echo -e "To skip this check (emergency): git commit --no-verify"
    exit 1
else
    echo -e "${GREEN}All pre-commit checks passed.${NC}"
    exit 0
fi
